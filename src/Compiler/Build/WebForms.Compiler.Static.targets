<Project>
  <Import Project="$(MSBuildThisFileDirectory)WebForms.Compiler.Static.Interceptor.targets" Condition="$(UseWebFormsInterceptors)" />

  <PropertyGroup>
    <_HasWebFormsError>false</_HasWebFormsError>
    <BeforeWebFormsCompilation>$(BeforeWebFormsCompilation);Build;AssignTargetPaths</BeforeWebFormsCompilation>
  </PropertyGroup>

  <Target Name="WebFormsCompilation" BeforeTargets="$(BeforeWebFormsCompilation)" AfterTargets="ResolveAssemblyReferences">
    <PropertyGroup>
      <_WebFormsTempDir>$(IntermediateOutputPath)webforms_compile/$([System.Guid]::NewGuid())</_WebFormsTempDir>
      <_WebFormsTempDir Condition="!$([System.IO.Path]::IsPathRooted($(_WebFormsTempDir)))">$(ProjectDir)$(_WebFormsTempDir)</_WebFormsTempDir>
      <_WebFormsTempDir>$([MSBuild]::NormalizeDirectory($(_WebFormsTempDir)))</_WebFormsTempDir>
      <_WebFormsPagesFileName>webforms.pages.json</_WebFormsPagesFileName>
      <_WebFormsPagesFile>$(_WebFormsTempDir)/$(_WebFormsPagesFileName)</_WebFormsPagesFile>
    </PropertyGroup>
  </Target>

  <Target Name="InvokeAspNetCompiler" AfterTargets="WebFormsCompilation" Condition="Exists($(AspNetCompilePath))">
    <PropertyGroup>
      <__AspNetCompileRspFilePath>$(_WebFormsTempDir)input.rsp</__AspNetCompileRspFilePath>
    </PropertyGroup>

    <ItemGroup>
      <__AspNetCompileRsp Include="-p $(MSBuildProjectDirectory)" />
      <__AspNetCompileRsp Include="$(_WebFormsTempDir)" />
      <__AspNetCompileRsp Include="-r &quot;%(ReferencePath.Identity)&quot;" />
    </ItemGroup>

    <Message Importance="low" Text="Input parameters for aspnet_compiler: @$(__AspNetCompileRspFilePath)" />

    <WriteLinesToFile File="$(__AspNetCompileRspFilePath)" Lines="@(__AspNetCompileRsp)" Overwrite="true" />

    <Exec Command="dotnet $(AspNetCompilePath) @$(__AspNetCompileRspFilePath)" ContinueOnError="true" />

    <PropertyGroup>
      <_HasWebFormsError Condition="!Exists('$(_WebFormsPagesFile)')">true</_HasWebFormsError>
    </PropertyGroup>
  </Target>

  <Target Name="AddWebFormsPagesFileToContent" AfterTargets="InvokeAspNetCompiler" Condition="!$(_HasWebFormsError) AND !$(UseWebFormsInterceptors)" BeforeTargets="AssignTargetPaths">
    <ItemGroup>
      <Content Include="$(_WebFormsPagesFile)" Link="$(_WebFormsPagesFileName)" CopyToOutputDirectory="PreserveNewest" />
    </ItemGroup>
  </Target>

  <Target Name="AddCompiledWebFormsAssembliesToReferences" AfterTargets="InvokeAspNetCompiler" BeforeTargets="FindReferencedAssembliesForReference">
    <ItemGroup>
      <CompiledAspxPages Include="$(_WebFormsTempDir)/*.dll" />
      <ReferencePath Include="@(CompiledAspxPages)">
        <FusionName>%(CompiledAspxPages->Filename)</FusionName>
        <CopyLocal>true</CopyLocal>
      </ReferencePath>
      <ReferenceCopyLocalPaths Include="@(COmpiledAspxPages)" />
    </ItemGroup>
  </Target>

  <Target Name="NotifyGenericWebFormsCompilationError" AfterTargets="InvokeAspNetCompiler" BeforeTargets="NotifyWebFormsCompilationError" Condition="$(_HasWebFormsError)">
    <Error Text="There was an error compiling WebForms assets." />
  </Target>

  <Target Name="AspNetCompilerNotFound" AfterTargets="WebFormsCompilation" Condition="!Exists($(AspNetCompilePath))">
    <Error Text="Could not find aspnet_compiler: $(AspNetCompilePath)" />
  </Target>

</Project>
