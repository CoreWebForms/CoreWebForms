<Project>

  <PropertyGroup>
    <_HasWebFormsError>false</_HasWebFormsError>
  </PropertyGroup>

  <Target Name="WebFormsCompilation" AfterTargets="CoreCompile" BeforeTargets="GetCopyToOutputDirectoryItems">
    <PropertyGroup>
      <_WebFormsIsDebug>false</_WebFormsIsDebug>
      <_WebFormsInputDir>$(MSBuildProjectDirectory)</_WebFormsInputDir>
      <_WebFormsIsDebug Condition=" '$(Configuration.ToUpper())' == 'DEBUG' ">true</_WebFormsIsDebug>
      <_WebFormsTempDir>$(IntermediateOutputPath)webforms_compile/</_WebFormsTempDir>
      <_WebFormsTempDir Condition="!$([System.IO.Path]::IsPathRooted($(_WebFormsTempDir)))">$(ProjectDir)$(_WebFormsTempDir)</_WebFormsTempDir>
      <_WebFormsTempDir>$([MSBuild]::NormalizeDirectory($(_WebFormsTempDir)))</_WebFormsTempDir>
      <_WebFormsPagesFileName>webforms.pages.json</_WebFormsPagesFileName>
      <_WebFormsPagesFile>$(_WebFormsTempDir)/$(_WebFormsPagesFileName)</_WebFormsPagesFile>
    </PropertyGroup>

    <ItemGroup>
      <_WebFormsCompilerInput Include="@(WebFormsFiles)" />
      <_WebFormsCompilerInput Include="@(WebFormsDesignerFiles)" />
      <_WebFormsCompilerInput Include="@(WebFormsCodeBehindFiles)" />
      <_WebFormsCompilerInput Include="@(WebFormsCodeBehindFiles)" />
      <_WebFormsCompilerInput Include="@(IntermediateAssembly)" />
    </ItemGroup>

    <ItemGroup>
      <_WebFormsCompilerOutput Include="$(_WebFormsTempDir)ASP.$([System.String]::Copy('%(WebFormsFiles.RecursiveDir)%(FileName)%(Extension)').Replace('\\', '_').Replace('/', '_')).dll" />
    </ItemGroup>

    <ItemGroup>
      <UpToDateCheckInput Include="@(_WebFormsCompilerInput)" />
      <UpToDateCheckOutput Include="@(_WebFormsCompilerOutput)" />
    </ItemGroup>

  </Target>

  <Target Name="InvokeAspNetCompiler" Inputs="@(_WebFormsCompilerInput)" Outputs="@(_WebFormsCompilerOutput)" AfterTargets="WebFormsCompilation" Condition="Exists($(AspNetCompilePath))">
    <PropertyGroup>
      <__AspNetCompileRspFilePath>$(_WebFormsTempDir)input.rsp</__AspNetCompileRspFilePath>
    </PropertyGroup>

    <RemoveDir Directories="$(_WebFormsTempDir)" />

    <ItemGroup>
      <__AspNetCompileRsp Include="-p &quot;$(_WebFormsInputDir)&quot;" />
      <__AspNetCompileRsp Condition="$(_WebFormsIsDebug)" Include="-d" />
      <__AspNetCompileRsp Include="&quot;$(_WebFormsTempDir)&quot;" />
      <__AspNetCompileRsp Include="-r &quot;%(ReferencePath.Identity)&quot;" />
      <__AspNetCompileRsp Include="-r &quot;%(IntermediateAssembly.Identity)&quot;" />
    </ItemGroup>

    <Message Importance="low" Text="Input parameters for aspnet_compiler: @$(__AspNetCompileRspFilePath)" />

    <WriteLinesToFile File="$(__AspNetCompileRspFilePath)" Lines="@(__AspNetCompileRsp)" Overwrite="true" />

    <Exec Command="dotnet $(AspNetCompilePath) @$(__AspNetCompileRspFilePath)" ContinueOnError="true" />

    <PropertyGroup>
      <_HasWebFormsError Condition="!Exists('$(_WebFormsPagesFile)')">true</_HasWebFormsError>
    </PropertyGroup>
  </Target>

  <Target Name="CollectWebFormsOutput" AfterTargets="InvokeAspNetCompiler" Condition="!$(_HasWebFormsError)" BeforeTargets="_CopyFilesMarkedCopyLocal;GetCopyToOutputDirectoryItems;GetCopyToPublishDirectoryItems">
    <ItemGroup>
      <AspxOutputFiles Include="$(_WebFormsTempDir)/*.pdb" />
      <AspxOutputFiles Include="$(_WebFormsTempDir)/*.dll" />

      <FileWrites Include="@(AspxOutputFiles)" />
      <FileWrites Include="$(_WebFormsPagesFile)" />

      <ContentWithTargetPath Include="$(_WebFormsPagesFile)"
                             TargetPath="$(TargetName).webforms.json"
                             CopyToOutputDirectory="PreserveNewest"
                             CopyToPublishDirectory="PreserveNewest" />
      <ContentWithTargetPath Include="@(AspxOutputFiles)"
                             TargetPath="webforms/%(FileName)%(Extension)"
                             CopyToOutputDirectory="PreserveNewest"
                             CopyToPublishDirectory="PreserveNewest" />
    </ItemGroup>
  </Target>

  <Target Name="NotifyGenericWebFormsCompilationError" AfterTargets="InvokeAspNetCompiler" BeforeTargets="NotifyWebFormsCompilationError" Condition="$(_HasWebFormsError)">
    <Error Text="There was an error compiling WebForms assets." />
  </Target>

  <Target Name="AspNetCompilerNotFound" AfterTargets="WebFormsCompilation" Condition="!Exists($(AspNetCompilePath))">
    <Error Text="Could not find aspnet_compiler: $(AspNetCompilePath)" />
  </Target>

</Project>
